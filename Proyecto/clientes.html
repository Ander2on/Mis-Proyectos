<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="Style/style.css">
        <title>Prestamo</title>
        <h1 class="letrasxl" id="logo">Prestamos A.B.M.J</h1> 
    </head>
    
    <header>
       <section class="menu">
        <div class="container-sm">
            <div class="row align-items-start">
              <div class="col">
                <a class="letrasMenu" href="index.html">Iniciar sesion</a>
              </div>
              <div class="col">
               <a class="letrasMenu" href="">Clientes</a>
              </div>
              <div class="col">
                <a class="letrasMenu" href="prestamos.html">Solicitud Prestamos</a>
              </div>
            
            </div>
       </section>
    </header>
<body>
    <section id="cliente">
      <form data-accion="nuevo" data-idcliente="0" id="formCliente">
        <h2 class="titulo2">Clientes</h2>
        <div id="CamposC">
            <div>
                <label class="LabelC" for="DUIC">DUI: </label>
                <input required pattern="[0-9]{9}" class="inputC" type="text" name="cedula" id="DUIC" placeholder="DUI">
            </div>
            <div>
                <label class="LabelC" for="nombreC">Nombres: </label>
                <input required pattern="[A-Za-zÑñ ]{3,30}" class="inputC" type="text" name="nombre" id="nombreC" placeholder="Nombres">
            </div>
            <div>
                <label class="LabelC" for="apellidoC">Apellidos: </label>
                <input required pattern="[A-Za-zÑñ ]{3,30}" class="inputC" type="text" name="apellido" id="apellidoC" placeholder="Apellidos">
            </div>
            <div>
              <label class="LabelC" for="sexoC">Sexo Biologico:</label>
              <select name="sexoC" id="SexC" class="selecciones">
                  <option value="M">Hombre</option>
                  <option value="F">Mujer</option>
              </select>
            </div>
            <div>
                <label class="LabelC" for="telefonoC">Telefono: </label>
                <input required pattern="[0-9]{8}" class="inputC" class="LabelC" type="text" name="telefono" id="telefonoC" placeholder="Telefono">
            </div>
            <div>
                <label class="LabelC" for="departamentoC">Departamento: </label>
                <input required pattern="[A-Za-zÑñ ]{5,25}" class="inputC" type="text" name="departamentoC" id="departamentoC" placeholder="Departamento">
            </div>
            <div>
                <label class="LabelC" for="ciudadC">Ciudad: </label>
                <input required pattern="[A-Za-zÑñ ]{5,25}" class="inputC" type="text" name="Ciudad" id="ciudadC" placeholder="Ciudad">
            </div>
            <div>

            </div>
            <div>
                <label class="LabelC" for="direccionC">Direccion: </label>
                <input required pattern="[A-Za-zÑñ ]{5,50}" class="inputC" type="text" name="direccion" id="direccionC" placeholder="Direccion">    
            </div>
            <div>
                <label class="LabelC" for="edadC">Edad: </label>
                <input required pattern="[0-9]{2}" class="inputC" type="number" name="edadC" id="edadC" placeholder="Edad" min="18" max="99">
                <button id="btn+C" onclick="incrementar()" class="btnEC" type="button">+</button>
                <button id="btn-C" onclick="decrementar()" class="btnEC" type="button">-</button>
            </div>
            <div>
                <label class="LabelC" for="SueldoC">Sueldo: </label>
                <input required pattern="[0-9]{9}" class="inputC" type="number" name="SuelcoC" id="SueldoC" placeholder="Sueldo">     
            </div>
            <div>
                <label class="LabelP" for="retraso">Retraso:</label>
                <select name="retraso" id="retrasoC" class="selecciones">
                    <option value="Si">Si</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div>
                <label class="LabelC" for="trabajoC">¿Trabaja?</label>
                <select name="TrabajoC" id="TrabajoC" class="selecciones">
                    <option value="Si">Si</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div>
              <button id="btnLimpiarC" class="btnC" type="reset">Limpiar</button>
            </div>  
            <div>
                <button id="btnNuevoC" class="btnC" type="submit" name="Nuevo">Nuevo</button>
                <button id="btnActualizarC" class="btnC" type="button" name="Guardar">Actualizar</button>
                <button id="btnEliminarC" class="btnC" type="button" name="Eliminar">Eliminar</button>
            </div>
        </div>
        <div id="alerta" class="alert alert-success d-none" role="alert">Hola</div>
    </form>
    <div id="tblClientes">
        <input id="txtBuscarC" type="text" placeholder="Buscar">
        <button id="btnBuscarC" class="btnC" type="button" name="Buscar">Buscar</button>
        <table class="table" id="tableC">
            <thead>
                    <tr>
                        <th colspan="9">
                            <input class="form-control" placeholder="Buscar clientes" type="text" 
                                name="txtBuscarCliente" id="txtBuscarCliente">
                        </th>
                    </tr>
              <tr>
                <th scope="col">DUI</th>
                <th scope="col">Nombres</th>
                <th scope="col">Apellidos</th>
                <th scope="col">Sexo</th>
                <th scope="col">Telefono</th>
                <th scope="col">Departamento</th>
                <th scope="col">Ciudad</th>
                <th scope="col">Direccion</th>
                <th scope="col">Edad</th>
                <th scope="col">Sueldo</th>
                <th scope="col">Retraso</th>
                <th scope="col">Trabajo</th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" 
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script>
        function incrementar(){
            let edad = document.getElementById("edadC").value;
            edad++;
            document.getElementById("edadC").value = edad;
        }
        function decrementar(){
            let edad = document.getElementById("edadC").value;
            edad--;
            document.getElementById("edadC").value = edad;
        }
        function actualizarCliente(data) {
            $("#DUIC").val(data.DUI);
            $("#nombresC").val(data.Nombres);
            $("#apellidosC").val(data.Apellidos);
            $("#sexoC").val(data.Sexo);
            $("#telefonoC").val(data.Telefono);
            $("#departamentoC").val(data.Departamento);
            $("#ciudadC").val(data.Ciudad);
            $("#direccionC").val(data.Direccion);
            $("#edadC").val(data.Edad);
            $("#SueldoC").val(data.Sueldo);
            $("#retrasoC").val(data.Retraso);
            $("#TrabajoC").val(data.Trabajo);
            
            document.getElementById("btnNuevoC").classList.add("d-none");
            document.getElementById("btnActualizarC").classList.remove("d-none");
            document.getElementById("btnEliminarC").classList.remove("d-none");

            console.log("Los datos a actualizar son: ",data);
        }
        function eliminarCliente(data){
            if(confirm(`¿Desea eliminar el cliente? ${data.Nombres}`)){
                let accion = "eliminar",
                    id_clientes = data.id_clientes,
                    datos = {accion,id_clientes};
                    console.log(datos);
                $.post('http://localhost:3000/administrar_clientes', JSON.stringify(datos), (dato) => {
                    console.log(dato);
                });
            }
        }
        function consultar_clientes(){
            $.get("http://localhost:3000/consultar_clientes", (data) => {
                data = data.resultado;
                console.log("Los datos son: ", data);
                let html = "";
                data.forEach(element => {
                    html += `<tr onclick='actualizarCliente(${JSON.stringify(data)})'>
                    <td>${element.DUI}</td>
                    <td>${element.Nombres}</td>
                    <td>${element.Apellidos}</td>
                    <td>${element.Sexo}</td>
                    <td>${element.Telefono}</td>
                    <td>${element.Departamento}</td>
                    <td>${element.Ciudad}</td>
                    <td>${element.Direccion}</td>
                    <td>${element.Edad}</td>
                    <td>${element.Sueldo}</td>
                    <td>${element.Retraso}</td>
                    <td>${element.Trabajo}</td>

                    <td>
                        <button class="btn btn-danger" onclick='eliminarCliente(${JSON.stringify(element)})'>Eliminar</button>    
                    </td>
                    </tr>`
                });
                $("#tableC tbody").html(html);
            }, "json");
        }

        function limpiar(){
            $("#formCliente").data("accion", "nuevo").data("idCliente", 0);
            $("#formCliente input[type=text]").val("");
        }
        function mostrarAlerta(msg){
        $("#alerta")
            .text(msg)
            .toggleClass("d-none");
        
        setTimeout(()=>{
            $("#alerta").toggleClass("d-none");
        }, 5000);
    }

        $(document).ready(() => {
            consultar_clientes();

            $("#formCliente")
            .on("reset", e => {limpiar(); })
            .submit(e =>{
                e.preventDefault();
                let accion = $("#formCliente").data("accion"),
                    id_clientes = $("#formCliente").data("idcliente"),
                    DUI = $("#DUIC").val(),
                    Nombres = $("#nombreC").val(),
                    Apellidos = $("#apellidoC").val(),
                    Sexo = $("#SexC").val(),
                    Telefono = $("#telefonoC").val(),
                    Departamento = $("#departamentoC").val(),
                    Ciudad = $("#ciudadC").val(),
                    Direccion = $("#direccionC").val(),
                    Edad = $("#edadC").val(),
                    Sueldo = $("#SueldoC").val(),
                    Retraso = $("#retrasoC").val(),
                    Trabajo = $("#TrabajoC").val(),
                    datos = {accion,id_clientes,DUI,Nombres,Apellidos,Sexo,Telefono,Departamento,Ciudad,Direccion,Edad, Sueldo, Retraso,Trabajo};

                    console.log("Entra al post con: ");
                    console.log(datos);
                    console.log(accion);
                    console.log(id_clientes);
                    $.post("http://localhost:3000/administrar_clientes", JSON.stringify(datos), (data, status) => {
                        if(data.resultado.indexOf("Error") == -1){
                            consultar_clientes();
                            limpiar();

                            $alert = $("#alerta").removeClass("alert-danger").addClass("alert-success").html(data.resultado);
                        } else {
                            $alert = $("#alerta").removeClass("alert-success").addClass("alert-danger").html(data.resultado);
                        }
                        mostrarAlerta(data.resultado);
                    }, "json");
            });

            $("#txtBuscarCliente").keyup(function(e){
                let valor = $(this).val(), $tableC = $("#tableC > tbody >tr");
                $tableC.show();
                let $no_encontrado = $tableC.filter(function(i, fila){
                    return $(this).find("td:not(:last)").text().toLowerCase().indexOf(valor.toLowerCase()) == -1;
                });
                $no_encontrado.hide();
            });
        });
    </script>
</body>
<footer>
  <a target="_blank" class="links" href="https://github.com/">Github</a>
  <p class="nombre">ProgramacionIII Proyecto Final</p>
</footer>
</html>